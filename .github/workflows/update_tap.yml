name: Update Tap

on:
  repository_dispatch:
    types: [update-formula]

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Debug payload  
        run: |
          echo "Event type: ${{ github.event.action }}"
          echo "Version: ${{ github.event.client_payload.version }}"
          echo "Release URL: ${{ github.event.client_payload.release_url }}"

      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: bixu/homebrew-apiary
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Get release assets
        id: get-assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use versions and shas from client payload
          version="${{ github.event.client_payload.version }}"
          sha256_aarch64_apple_darwin="${{ github.event.client_payload.sha256_aarch64_apple_darwin }}"
          sha256_x86_64_apple_darwin="${{ github.event.client_payload.sha256_x86_64_apple_darwin }}"
          sha256_x86_64_unknown_linux_gnu="${{ github.event.client_payload.sha256_x86_64_unknown_linux_gnu }}"
          
          # Convert HTML URL to API URL if needed
          release_url="${{ github.event.client_payload.release_url }}"
          if [[ "$release_url" == *"github.com"* ]]; then
            # Convert HTML URL to API URL
            # From: https://github.com/bixu/apiary/releases/tag/v1.0.0
            # To: https://api.github.com/repos/bixu/apiary/releases/tags/v1.0.0
            api_url=$(echo "$release_url" | sed 's|github.com|api.github.com/repos|' | sed 's|/releases/tag/|/releases/tags/|')
          else
            api_url="$release_url"
          fi
          
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "sha256_aarch64_apple_darwin=$sha256_aarch64_apple_darwin" >> $GITHUB_OUTPUT
          echo "sha256_x86_64_apple_darwin=$sha256_x86_64_apple_darwin" >> $GITHUB_OUTPUT
          echo "sha256_x86_64_unknown_linux_gnu=$sha256_x86_64_unknown_linux_gnu" >> $GITHUB_OUTPUT
          echo "arm_sha256=$arm_sha256" >> $GITHUB_OUTPUT

      - name: Update formula
        run: |
          cd homebrew-tap
          
          VERSION="${{ steps.get-assets.outputs.version }}"
          SHA256_ARM="${{ steps.get-assets.outputs.sha256_aarch64_apple_darwin }}"
          SHA256_INTEL="${{ steps.get-assets.outputs.sha256_x86_64_apple_darwin }}"
          SHA256_LINUX="${{ steps.get-assets.outputs.sha256_x86_64_unknown_linux_gnu }}"
          
          # Update version
          sed -i.bak "s/version '[^']*'/version '$VERSION'/" Formula/apiary.rb
          
          # Update SHA256 for ARM - find the line with sha256 within on_arm block
          awk -v sha="$SHA256_ARM" '
            /on_arm/ { in_arm=1 }
            in_arm && /sha256/ { 
              sub(/sha256 '\''[0-9a-f]{64}'\''/, "sha256 '\''" sha "'\''")
              in_arm=0
            }
            { print }
          ' Formula/apiary.rb > Formula/apiary.rb.tmp && mv Formula/apiary.rb.tmp Formula/apiary.rb
          
          # Update SHA256 for Intel - find the line with sha256 within on_intel block
          awk -v sha="$SHA256_INTEL" '
            /on_intel/ { in_intel=1 }
            in_intel && /sha256/ { 
              sub(/sha256 '\''[0-9a-f]{64}'\''/, "sha256 '\''" sha "'\''")
              in_intel=0
            }
            { print }
          ' Formula/apiary.rb > Formula/apiary.rb.tmp && mv Formula/apiary.rb.tmp Formula/apiary.rb
          
          # Update SHA256 for Linux - find the line with sha256 within on_linux block
          awk -v sha="$SHA256_LINUX" '
            /on_linux/ { in_linux=1 }
            in_linux && /sha256/ { 
              sub(/sha256 '\''[0-9a-f]{64}'\''/, "sha256 '\''" sha "'\''")
              in_linux=0
            }
            { print }
          ' Formula/apiary.rb > Formula/apiary.rb.tmp && mv Formula/apiary.rb.tmp Formula/apiary.rb
          
          # Remove backup file
          rm -f Formula/apiary.rb.bak
          
          # Verify the updates
          echo "Updated formula:"
          cat Formula/apiary.rb

      - name: Commit and push changes
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/apiary.rb
          git commit -m "Update apiary to version ${{ steps.get-assets.outputs.version }}"
          git push
